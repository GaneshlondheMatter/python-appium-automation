name: Android Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  android-tests:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3️⃣ Install Python dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4️⃣ Start Android Emulator (Docker)
    - name: Start Android Emulator
      run: |
        docker run -d \
          --name android-emulator \
          -p 4723:4723 \
          -p 6080:6080 \
          -e DEVICE="Samsung Galaxy S10" \
          budtmo/docker-android:emulator_11.0

    # 5️⃣ Wait for emulator to boot
    - name: Wait for Emulator
      run: |
        sleep 60
        docker exec android-emulator adb devices

    # 6️⃣ Install APK
    - name: Install APK
      run: |
        docker exec android-emulator adb install -r apps/MatterVerseQA_1.91.apk

    # 7️⃣ Run pytest
    - name: Run tests
      env:
        APPIUM_SERVER_URL: http://127.0.0.1:4723
      run: |
        pytest -v
